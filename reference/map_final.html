<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>浙江大学紫金港校区 — 秋季植物展示</title>
    <!-- Leaflet 样式 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <style>
        :root {
            --primary: #1e622e;
            --primary-light: #f0fdf4;
            --accent: #eab308;
            --glass: rgba(255, 255, 255, 0.92);
            --shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.1);
            --sidebar-width: 380px;
            --transition-speed: 0.4s;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
        }

        /* 顶部栏 */
        #header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--glass);
            backdrop-filter: blur(10px);
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 1px 10px rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        #header h1 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--primary);
            font-weight: 700;
        }

        /* 主容器 */
        #main-container {
            display: flex;
            height: 100vh;
            padding-top: 60px;
            box-sizing: border-box;
            position: relative;
        }

        /* 左侧资料卡片列表 */
        #sidebar {
            width: var(--sidebar-width);
            background: #f8fafc;
            height: 100%;
            overflow-y: auto;
            border-right: 1px solid #e2e8f0;
            z-index: 1000;
            padding: 16px;
            box-sizing: border-box;
            transition: transform var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1), 
                        width var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
            scrollbar-width: thin;
            position: relative;
        }

        body.sidebar-collapsed #sidebar {
            width: 0;
            padding: 16px 0;
            transform: translateX(-100%);
        }

        /* 折叠切换按钮 */
        #toggle-sidebar {
            position: absolute;
            left: var(--sidebar-width);
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 60px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-left: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            z-index: 1005;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: left var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 4px 0 10px rgba(0,0,0,0.05);
        }

        body.sidebar-collapsed #toggle-sidebar {
            left: 0;
        }

        #toggle-sidebar svg {
            transition: transform var(--transition-speed);
            color: var(--primary);
        }

        body.sidebar-collapsed #toggle-sidebar svg {
            transform: rotate(180deg);
        }

        /* 植物卡片 */
        .plant-card {
            background: white;
            border-radius: 16px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #f1f5f9;
            cursor: pointer;
            min-width: 340px;
        }

        .plant-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px -5px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .plant-card .image-container {
            position: relative;
            height: 160px;
        }

        .plant-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .plant-card .tag {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            backdrop-filter: blur(4px);
        }

        .plant-card-content {
            padding: 16px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn {
            flex: 1;
            padding: 8px 0;
            border-radius: 8px;
            border: none;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; color: var(--primary); border: 1px solid var(--primary); }

        /* 地图图层切换器 */
        #map-controls {
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .map-type-btn {
            background: white;
            border: 2px solid white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            cursor: pointer;
            width: 80px;
            height: 60px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
        }

        .map-type-btn .thumb {
            width: 100%;
            height: 40px;
            background-size: cover;
            background-position: center;
        }

        .map-type-btn span {
            font-size: 10px;
            font-weight: bold;
            color: #64748b;
            padding: 2px 0;
        }

        .map-type-btn.active {
            border-color: var(--primary);
        }

        .map-type-btn.active span {
            color: var(--primary);
            background: var(--primary-light);
            width: 100%;
            text-align: center;
        }

        /* 地图容器 */
        #map {
            flex: 1;
            height: 100%;
            background: #f1f5f9;
        }

        #status-bar {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            background: var(--glass);
            padding: 8px 20px;
            border-radius: 30px;
            box-shadow: var(--shadow);
            font-size: 0.85rem;
            display: none;
            border: 1px solid rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <header id="header">
        <h1>浙江大学紫金港校区 · 秋季植物地图</h1>
        <div class="header-actions">
            <button id="locate-me-btn" class="btn btn-primary" style="padding: 6px 16px; width: auto;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                我的位置
            </button>
        </div>
    </header>

    <main id="main-container">
        <aside id="sidebar">
            <div id="plant-list"></div>
        </aside>

        <button id="toggle-sidebar" title="收起/展开列表">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>

        <div id="map-controls">
            <button class="map-type-btn" id="btn-sat" onclick="setMapType('sat')">
                <div class="thumb" style="background-image: url('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/16/27236/53874')"></div>
                <span>实景地图</span>
            </button>
            <button class="map-type-btn active" id="btn-light" onclick="setMapType('light')">
                <div class="thumb" style="background-image: url('https://a.basemaps.cartocdn.com/light_all/16/53874/27236.png')"></div>
                <span>简约导航</span>
            </button>
        </div>

        <div id="map"></div>
    </main>

    <div id="status-bar">正在定位您的位置...</div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <script>
        const plants = [
            {
                id: 'p1',
                name: '银杏',
                latin: 'Ginkgo biloba',
                img: 'https://images.unsplash.com/photo-1501004318641-b39e6451bec6?w=800&q=60',
                coords: [30.3095, 120.0817],
                tag: '金黄',
                description: '落叶乔木。秋季叶片转为金黄色。紫金港校区东西大道两旁均有种植。'
            },
            {
                id: 'p2',
                name: '鸡爪槭',
                latin: 'Acer palmatum',
                img: 'https://images.unsplash.com/photo-1502082553048-f009c37129b9?w=800&q=60',
                coords: [30.3072, 120.0839],
                tag: '红叶',
                description: '落叶小乔木。秋后叶片由绿变红，形态优美。'
            },
            {
                id: 'p3',
                name: '桂花',
                latin: 'Osmanthus fragrans',
                img: 'https://images.unsplash.com/photo-1508739773434-c26b3d09e071?w=800&q=60',
                coords: [30.3015, 120.0845],
                tag: '馥郁',
                description: '常绿阔叶乔木。秋季开花，香气袭人。'
            }
        ];

        // 默认备用起点（浙大南门）
        const FALLBACK_START = [30.302959, 120.08083];
        let userMarker = null;

        const map = L.map('map', {
            zoomControl: false,
            minZoom: 10,
            maxZoom: 18
        }).setView([30.3081, 120.0827], 15);

        const layers = {
            sat: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Esri'
            }),
            light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: 'CartoDB'
            })
        };

        layers.light.addTo(map);

        window.setMapType = function(type) {
            Object.values(layers).forEach(layer => map.removeLayer(layer));
            layers[type].addTo(map);
            document.querySelectorAll('.map-type-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${type}`).classList.add('active');
        };

        L.control.zoom({ position: 'bottomright' }).addTo(map);

        let routingControl = L.Routing.control({
            waypoints: [],
            router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
            show: false,
            addWaypoints: false,
            lineOptions: { styles: [{ color: '#1e622e', weight: 6, opacity: 0.8 }] },
            createMarker: () => null
        }).addTo(map);

        const markers = {};

        // 核心：获取实时位置的 Promise 化函数
        function getLiveLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject('浏览器不支持定位');
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (pos) => resolve([pos.coords.latitude, pos.coords.longitude]),
                    (err) => reject(err),
                    { enableHighAccuracy: true, timeout: 8000 }
                );
            });
        }

        function initApp() {
            const listContainer = document.getElementById('plant-list');
            plants.forEach(plant => {
                const card = document.createElement('div');
                card.className = 'plant-card';
                card.innerHTML = `
                    <div class="image-container"><img src="${plant.img}"><span class="tag">${plant.tag}</span></div>
                    <div class="plant-card-content">
                        <h3>${plant.name}</h3>
                        <div class="btn-group">
                            <button class="btn btn-outline" onclick="focusPlant('${plant.id}', event)">查看位置</button>
                            <button class="btn btn-primary" onclick="navigateToPlant('${plant.id}', event)">开始导航</button>
                        </div>
                    </div>
                `;
                card.onclick = () => focusPlant(plant.id);
                listContainer.appendChild(card);

                const marker = L.marker(plant.coords).addTo(map);
                marker.bindPopup(`<strong>${plant.name}</strong>`);
                markers[plant.id] = marker;
            });

            document.getElementById('toggle-sidebar').onclick = () => {
                document.body.classList.toggle('sidebar-collapsed');
                setTimeout(() => map.invalidateSize(), 400);
            };

            // “我的位置”按钮逻辑
            document.getElementById('locate-me-btn').onclick = async () => {
                showStatus('正在努力获取您的精确GPS位置...');
                try {
                    const coords = await getLiveLocation();
                    updateUserMarker(coords);
                    map.setView(coords, 17);
                    hideStatus();
                } catch (e) {
                    showStatus('定位失败，请确保已授权 HTTPS 环境下的定位权限');
                    setTimeout(hideStatus, 3000);
                }
            };
        }

        function updateUserMarker(coords) {
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker(coords, {
                radius: 8,
                fillColor: '#2563eb',
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map).bindTooltip("您在这里").openTooltip();
        }

        function showStatus(text) {
            const bar = document.getElementById('status-bar');
            bar.innerText = text;
            bar.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('status-bar').style.display = 'none';
        }

        window.focusPlant = (id, e) => {
            if (e) e.stopPropagation();
            map.setView(plants.find(p => p.id === id).coords, 17);
            markers[id].openPopup();
        };

        // 导航逻辑升级：尝试获取实时定位
        window.navigateToPlant = async (id, e) => {
            if (e) e.stopPropagation();
            const plant = plants.find(p => p.id === id);
            
            showStatus('正在请求实时位置以规划最佳路线...');
            
            let startPoint;
            try {
                // 1. 尝试获取实时 GPS
                startPoint = await getLiveLocation();
                updateUserMarker(startPoint);
            } catch (err) {
                // 2. 定位失败则使用备用点
                console.warn('Location access denied or timed out:', err);
                startPoint = FALLBACK_START;
                showStatus('定位不可用（请检查权限），为您展示从南门出发的路线');
                setTimeout(hideStatus, 4000);
            }
            
            // 3. 设置路线
            routingControl.setWaypoints([
                L.latLng(startPoint[0], startPoint[1]),
                L.latLng(plant.coords[0], plant.coords[1])
            ]);

            // 4. 自动缩放以适应全路线
            const bounds = L.latLngBounds([startPoint, plant.coords]);
            map.fitBounds(bounds, { padding: [100, 100] });

            if (!document.getElementById('status-bar').innerText.includes('南门')) {
                hideStatus();
            }
        };

        initApp();
    </script>
</body>
</html>